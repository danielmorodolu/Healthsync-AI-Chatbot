<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthSync AI Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-content">
                <img src="{{ url_for('static', filename='images/healthsync-logo.png') }}" alt="HealthSync Logo" class="logo">
                <h1 class="header-title">HealthSync AI Chat :</h1>
            </div>
            <div class="fitbit-data">
                <span>SpO2: <span class="fitbit-value">{{ smartwatch_data.sp02 }}%</span></span>
                <span>Heart Rate: <span class="fitbit-value">{{ smartwatch_data.heart_rate }} bpm</span></span>
            </div>
            <div class="nav-menu">
                <button class="nav-toggle" onclick="toggleNav()">â˜°</button>
                <div class="nav-dropdown" id="navDropdown">
                    <a href="{{ url_for('chat_get') }}">Chat</a>
                    {% if fitbit_user %}
                    <a href="{{ url_for('fitbit_info') }}">Fitbit Insights</a>
                    <a href="{{ url_for('health_dashboard') }}">Health Dashboard</a>
                    {% endif %}
                    <a href="{{ url_for('profile') }}">Profile & Settings</a>
                </div>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
                <div class="message {{ 'bot-message' if message.sender == 'bot' else 'user-message' }}">
                    {{ message.text | safe }}
                    <span class="timestamp">{{ message.timestamp }}</span>
                </div>
            {% endfor %}
        </div>
        <div class="chat-input">
            <div class="profile-info">
                Age: {{ age }} | Gender: {{ sex }} <a href="{{ url_for('edit_profile_get') }}">Edit</a>
            </div>
            <form id="chat-form">
                <input type="text" name="input" placeholder="Type your message or symptom..." required>
                <button type="submit">Send</button>
                <button type="button" class="start-diagnosis-btn" onclick="resetSession()">Start New Diagnosis</button>
            </form>
            {% if not has_health_data %}
            <div class="health-data-prompt">
                Enhance your diagnosis by adding health data (e.g., temperature, blood pressure). <a href="{{ url_for('health_data_get') }}">Add Health Data</a>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        function toggleNav() {
            const navDropdown = document.getElementById('navDropdown');
            navDropdown.style.display = navDropdown.style.display === 'block' ? 'none' : 'block';
        }

        function resetSession() {
            fetch('/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_id: '{{ user_id }}' })
            })
            .then(response => response.json())
            .then(data => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot-message';
                messageDiv.innerHTML = `${data.message}<span class="timestamp">${new Date().toLocaleTimeString()}</span>`;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(error => console.error('Error:', error));
        }

        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = this.querySelector('input[name="input"]').value;
            const userId = '{{ user_id }}';
            const age = {{ age }};
            const sex = '{{ sex }}';

            const chatMessages = document.getElementById('chatMessages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user-message';
            userMessageDiv.innerHTML = `${input}<span class="timestamp">${new Date().toLocaleTimeString()}</span>`;
            chatMessages.appendChild(userMessageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input, user_id: userId, age, sex })
            })
            .then(response => response.json())
            .then(data => {
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'message bot-message';
                botMessageDiv.innerHTML = `${data.message}<span class="timestamp">${new Date().toLocaleTimeString()}</span>`;
                chatMessages.appendChild(botMessageDiv);

                if (data.follow_up) {
                    const followUpDiv = document.createElement('div');
                    followUpDiv.className = `follow-up ${data.follow_up === "This is my final assessment based on your symptoms." ? 'final' : ''}`;
                    if (data.follow_up === "This is my final assessment based on your symptoms.") {
                        followUpDiv.textContent = data.follow_up;
                    } else {
                        followUpDiv.innerHTML = `
                            <p>${data.follow_up.text}</p>
                            ${data.follow_up.ui_hint === "dropdown" ? `
                                <select name="answer" ${data.follow_up.type === "group_multiple" ? 'multiple' : ''}>
                                    ${data.follow_up.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                                </select>
                            ` : data.follow_up.ui_hint === "checkboxes" ? `
                                ${data.follow_up.options.map(option => `
                                    <label><input type="checkbox" name="answer" value="${option}"> ${option}</label><br>
                                `).join('')}
                            ` : `
                                <input type="text" name="free_text" placeholder="Type your answer...">
                            `}
                            <button class="follow-up-submit">Submit</button>
                        `;
                        followUpDiv.querySelector('.follow-up-submit').addEventListener('click', function() {
                            const answer = data.follow_up.ui_hint === "dropdown" ? 
                                followUpDiv.querySelector('select').value : 
                                data.follow_up.ui_hint === "checkboxes" ? 
                                    Array.from(followUpDiv.querySelectorAll('input[name="answer"]:checked')).map(input => input.value) : 
                                    followUpDiv.querySelector('input[name="free_text"]').value;

                            fetch('/chat', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    user_id: userId,
                                    age: age,
                                    sex: sex,
                                    [data.follow_up.ui_hint === "text" ? 'free_text' : 'answer']: answer
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                followUpDiv.remove();
                                const botMessageDiv = document.createElement('div');
                                botMessageDiv.className = 'message bot-message';
                                botMessageDiv.innerHTML = `${data.message}<span class="timestamp">${new Date().toLocaleTimeString()}</span>`;
                                chatMessages.appendChild(botMessageDiv);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            });
                        });
                    }
                    chatMessages.appendChild(followUpDiv);
                }

                chatMessages.scrollTop = chatMessages.scrollHeight;
                this.reset();
            })
            .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html>